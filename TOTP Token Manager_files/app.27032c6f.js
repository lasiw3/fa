(function(){"use strict";var e={218:function(e,t,o){var s=o(6369),r=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("el-container",[t("el-header",[t("h1",{staticClass:"text-center display-4"},[e._v("TOTP Token Manager")])]),t("div",{staticClass:"el-main"},[t("el-row",{staticClass:"input-row",attrs:{justify:"center"}},[t("el-input",{attrs:{placeholder:"用户信息",size:"medium"},model:{value:e.remarkInput,callback:function(t){e.remarkInput=t},expression:"remarkInput"}}),t("el-input",{attrs:{placeholder:"密钥",size:"medium"},model:{value:e.secretInput,callback:function(t){e.secretInput=t},expression:"secretInput"}}),t("el-button",{attrs:{type:"primary",size:"medium"},on:{click:e.saveSecret}},[e._v("添加")])],1),t("el-row",{staticClass:"mt-4",attrs:{justify:"center"}},[t("el-col",[t("el-upload",{staticClass:"upload-demo",attrs:{action:"#",accept:"image/*","show-file-list":!1,drag:"","before-upload":e.handleFileUpload}},[t("i",{staticClass:"el-icon-upload"}),t("div",{staticClass:"el-upload__text"},[e._v("将令牌二维码拖拽到此区域，或"),t("em",[e._v("点击上传")])])])],1)],1),t("el-row",[t("el-col",[t("el-button-group",[t("el-upload",{attrs:{action:"#",accept:"application/json","show-file-list":!1,"before-upload":e.handleImport}},[t("el-button",{attrs:{type:"success",size:"mini"}},[e._v("导入")])],1),t("el-button",{attrs:{type:"primary",size:"mini"},on:{click:e.handleExport}},[e._v("导出")]),t("el-button",{attrs:{type:"danger",size:"mini"},on:{click:e.handleClear}},[e._v("清空")])],1)],1),t("el-col",[e.showTag?t("el-tag",{attrs:{type:"sucess"}},[e._v("当前登录的Github账户 "+e._s(e.userName))]):e._e()],1)],1),t("el-row",{staticClass:"mt-4",attrs:{justify:"center"}},[t("el-col",{attrs:{span:11}},[t("timeCount")],1),t("el-col",{attrs:{span:13}},[t("el-button-group",[t("el-tag",{attrs:{type:"info"}},[e._v("是否同步")]),t("el-tooltip",{attrs:{placement:"top"}},[t("div",{attrs:{slot:"content"},slot:"content"},[e._v("开启同步功能说明"),t("br"),t("br"),e._v("1、打开同步按钮,通过你的Github账号对Gist存储进行授权 "),t("br"),t("br"),e._v("2、Gist上创建名为【totp_secret_backup.json】的文件 "),t("br"),t("br"),e._v("3、点【上传】会把本地数据覆盖到Gist "),t("br"),t("br"),e._v("4、点【恢复】会把Gist数据和本地数据合并 "),t("br"),t("br"),e._v("同步数据过程中本站不存储任何数据 ")]),t("el-switch",{attrs:{"active-color":"#13ce66","inactive-color":"#ff4949"},on:{change:e.handleSwitchChange},model:{value:e.syncluodflag,callback:function(t){e.syncluodflag=t},expression:"syncluodflag"}})],1),t("el-button",{attrs:{type:"primary",size:"mini",disabled:!e.syncluodflag},on:{click:e.uploadSync}},[e._v("上传")]),t("el-button",{attrs:{type:"success",size:"mini",disabled:!e.syncluodflag},on:{click:e.downloadSync}},[e._v("恢复")])],1)],1)],1),t("el-row",{staticClass:"mt-4",attrs:{justify:"center"}},[t("el-col",[t("el-table",{attrs:{data:e.tokenData}},[t("el-table-column",{attrs:{label:"序号",width:"60"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.$index+1)+" ")]}}])}),t("el-table-column",{attrs:{prop:"remark",label:"用户信息",width:"150"}}),t("el-table-column",{attrs:{prop:"token",label:"令牌",width:"100"}}),t("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(o){return[t("el-button-group",[t("el-link",{attrs:{type:"primary"},on:{click:function(t){return e.copyToken(o.row.token)}}},[e._v("复制 |")]),t("el-link",{attrs:{type:"success"},on:{click:function(t){return e.showQRCode(o.row.secret,o.row.remark)}}},[e._v("显示 |")]),t("el-link",{attrs:{type:"danger"},on:{click:function(t){return e.deleteToken(o.row.uuid)}}},[e._v("删除")])],1)]}}])})],1)],1)],1),t("el-dialog",{attrs:{visible:e.showQRCodeDialog,title:"可直接用APP扫描",width:"20%",align:"center"},on:{"update:visible":function(t){e.showQRCodeDialog=t}}},[t("div",{staticClass:"qrcode",attrs:{id:"qrcode"}})])],1),t("el-footer",[t("div",{staticClass:"container text-center"})])],1)],1)},n=[],a=(o(7658),o(6229),o(7330),o(2062),o(5550)),i=o(2614),c=o.n(i),l=o(851),h=o.n(l),u=o(4161),g=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"Box"},[t("div",{staticStyle:{position:"relative"}},[t("el-progress",{attrs:{type:"circle",width:60,percentage:e.percentage,"show-text":!1,"stroke-width":"4"}}),t("div",{staticClass:"time"},[e.countdown>0?t("h2",[e._v(e._s(e.countdown)+"秒")]):e._e()])],1)])])},d=[],m={data(){return{countdown:30,countdownNum:30,timer:null,is_pause:!0,percentage:100}},methods:{updateTokenIfNeeded(){const e=(new Date).getSeconds();this.countdown=30-e%30,this.percentage=100*(this.countdown/this.countdownNum).toFixed(2)}},created(){setInterval(this.updateTokenIfNeeded,1e3)}},p=m,f=o(3736),k=(0,f.Z)(p,g,d,!1,null,"1751ed84",null),v=k.exports,w={components:{timeCount:v},name:"App",data(){return{remarkInput:"",secretInput:"",tokenData:[],secondsToRefresh:0,showQRCodeDialog:!1,closeQRCodeDialog:!1,qrCodeSecret:"",syncluodflag:"1"===localStorage.getItem("remoteSync"),remoteFileName:"totp_secret_backup.json",showTag:!1,userName:""}},methods:{generateTOTP(e){const t=new a.GF(e),o=t.now();return o},updateTokenIfNeeded(){const e=(new Date).getSeconds();e%30===0?this.tokenData.forEach((e=>{e.token=this.generateTOTP(e.secret)})):this.secondsToRefresh=30-e%30},deleteAll(){confirm("您确定要执行这个操作吗？")&&(this.tokenData=[],this.saveTokens())},saveSecret(){if(!this.remarkInput||!this.secretInput)return void this.$message.error("请输入网站备注和密钥。");try{this.generateTOTP(this.secretInput)}catch(t){return void this.$message.error("可能输入的密钥不合法。本站目前仅支持base32形式的密钥。"+t)}const e={uuid:this.generateUUID(),remark:this.remarkInput,secret:this.secretInput,token:this.generateTOTP(this.secretInput)};this.tokenData.push(e),this.saveTokens(),this.remarkInput="",this.secretInput=""},copyToken(e){navigator.clipboard.writeText(e).then((()=>this.$message.success("复制成功！"))).catch((()=>this.$message.error("复制失败")))},showQRCode(e,t){this.showQRCodeDialog=!0;const o=`otpauth://totp/${t}?secret=${e}&issuer=${t}`;this.$nextTick((()=>{document.getElementById("qrcode").innerHTML="",new(c())("qrcode",{text:o,width:120,height:120})}))},deleteToken(e){this.tokenData=this.tokenData.filter((t=>t.uuid!==e)),this.saveTokens()},handleFileUpload(e){const t=e.type.startsWith("image/");if(!t)return this.$message.error("只允许上传图片文件！"),!1;const o=new FileReader;o.onload=e=>{const t=new Image;t.src=e.target.result,t.onload=()=>{const e=document.createElement("canvas"),o=e.getContext("2d");e.width=t.width,e.height=t.height,o.drawImage(t,0,0);const s=o.getImageData(0,0,e.width,e.height),r=h()(s.data,s.width,s.height);if(r){const e=this.parseOtpAuthLink(r.data);e?(console.log(e.remark+e.secret),e.remark&&e.secret&&(this.tokenData.push({uuid:this.generateUUID(),remark:e.remark,secret:e.secret,token:this.generateTOTP(e.secret)}),this.saveTokens())):this.$message.error("解析二维码失败，请选择或者粘贴正确的totp令牌二维码")}else this.$message.error("未识别到二维码")}},o.readAsDataURL(e)},parseOtpAuthLink(e){console.log("ccccccccc"),console.log(e);const t=/otpauth:\/\/totp\/([^?]+)\?secret=([^&]+)/,o=e.match(t);if(console.log(o),o){const e=o[1].trim(),t=o[2].trim();return{remark:e,secret:t}}return null},handleImport(e){const t=new FileReader;return t.onload=e=>{const t=JSON.parse(e.target.result);t.forEach((e=>{e.remark&&e.secret&&this.tokenData.push({uuid:e.uuid,remark:e.remark,secret:e.secret,token:this.generateTOTP(e.secret)})})),this.saveTokens()},t.readAsText(e),!1},handleExport(){const e=JSON.stringify(this.tokenData.map((e=>({uuid:e.uuid,remark:e.remark,secret:e.secret})))),t=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download="backup.json",s.click()},handleClear(){this.$confirm("您确定要执行这个操作吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.tokenData=[],this.saveTokens(),this.$message({type:"success",message:"清空成功!"})})).catch((()=>{this.$message({type:"info",message:"已取消清空"})}))},saveTokens(){localStorage.setItem("tokenData",JSON.stringify(this.tokenData))},generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0,o="x"==e?t:3&t|8;return o.toString(16)}))},handleSwitchChange(e){if(e){if(null!=localStorage.getItem("ghUsername")&&(this.showTag=!0,this.userName=localStorage.getItem("ghUsername")),localStorage.setItem("remoteSync","1"),!localStorage.getItem("ghToken"))return void this.loginWithGitHub()}else this.showTag=!1,localStorage.setItem("remoteSync","0")},uploadSync(){const e=JSON.parse(localStorage.getItem("tokenData"));if(0===e.length)return void this.$message.error("没有需要上传的数据！");if(!localStorage.getItem("ghToken"))return void this.loginWithGitHub();if(null==localStorage.getItem("ghGistId"))return void this.$message.error(`请先在github上创建文件名为 ${this.remoteFileName} 的gist，然后刷新本页面`);const t=[];e.forEach((e=>{void 0!=e.uuid&&void 0!=e.secret&&void 0!=e.remark&&t.push(e)})),this.$confirm("上传将会覆盖服务端的内容，如果想要增量合并，请先点击下载后确认本地数据没问题再上传！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.updateGistContent(JSON.stringify(t)).then((()=>{this.$message.success("上传成功")})).catch((e=>{console.error("Error:",e),this.$message.error("上传失败")}))}))},loginWithGitHub(){this.$confirm("你确定要使用同步功能吗?将会登陆Github以同步数据到Gist，过程中依赖客户端能够访问Github。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{const e=location.origin,t=`https://github.com/login/oauth/authorize?client_id=Iv1.fe1bef9a2c8c256d&redirect_uri=${e}`;window.location.href=t})).catch((()=>{localStorage.setItem("remoteSync","0"),this.syncluodflag=!1,this.$message({type:"info",message:"已取消同步"})}))},checkGitHubAuthentication(){if(new URLSearchParams(window.location.search).get("code")){const e={code:new URLSearchParams(window.location.search).get("code")};console.log(new URLSearchParams(window.location.search).get("code")),u.Z.post("https://gittoken.ping8.top",e,{"Content-Type":"application/json",Accept:"application/json"}).then((e=>{const t=e.data;if(console.log(t),console.log(e.data.access_token),void 0!=t.error)this.$message.error("登录失败，请重试");else{const e=t.access_token;localStorage.setItem("ghToken",e),this.$message.success("登录成功"),location.href="/"}})).catch((e=>{this.$message.error("登录失败，请重试"),console.error("Error:",e)}))}},getUserUsername(){return console.log("get username info"),new Promise(((e,t)=>{fetch("https://api.github.com/user",{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("ghToken")}`}}).then((e=>e.json())).then((o=>{console.log(o),void 0==o.login?(t(new Error("Failed to get username.")),this.loginWithGitHub()):localStorage.setItem("ghUsername",o.login),e(o.login)})).catch((e=>{t(e)}))}))},findGistId(){fetch(`https://api.github.com/users/${localStorage.getItem("ghUsername")}/gists`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("ghToken")}`}}).then((e=>e.json())).then((e=>{let t=null;for(const o of e){const e=o.id;if(o.files&&o.files[this.remoteFileName]){t=e;break}}t?(console.log(`Found Gist ID: ${t}`),localStorage.setItem("ghGistId",t)):(this.$message.error(`请先在github上创建文件名为${this.remoteFileName}的gist，然后刷新本页面`),console.log("please create gist manually with name"+this.remoteFileName))})).catch((e=>{console.error("Error:",e)}))},updateGistContent(e){return new Promise(((t,o)=>{const s=`https://api.github.com/gists/${localStorage.getItem("ghGistId")}`,r={files:{[this.remoteFileName]:{content:e}}};fetch(s,{method:"PATCH",headers:{Authorization:`Bearer ${localStorage.getItem("ghToken")}`},body:JSON.stringify(r)}).then((e=>e.json())).then((e=>{e&&e.id?t(e):o(new Error("Failed to update the Gist."))})).catch((e=>{o(e)}))}))},getGistContent(){return new Promise(((e,t)=>{const o=`https://api.github.com/gists/${localStorage.getItem("ghGistId")}`;fetch(o,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("ghToken")}`}}).then((e=>{if(200===e.status)return e.json();401===e.status?(this.$message.error("疑似凭证失效，请重新登录Github"),this.loginWithGitHub()):404===e.status?this.$message.error(`请先在github上创建文件名为${this.remoteFileName}的gist`):(this.$message.error("未知错误"),t(new Error(`Failed to fetch data. Status code: ${e.status}`)))})).then((o=>{const s=o.files;if(s&&s[this.remoteFileName]){const t=s[this.remoteFileName].content;e(t)}else this.$message.error(`请先在github上创建文件名为${this.remoteFileName}的gist`),t(new Error(`File '${this.remoteFileName}' not found in the Gist.`))})).catch((e=>{t(e)}))}))},downloadSync(){"1"==localStorage.getItem("remoteSync")?null!=localStorage.getItem("ghGistId")?this.getGistContent().then((e=>{var t=JSON.parse(localStorage.getItem("tokenData"))||[],o=JSON.parse(e)||[],s=0;o.forEach((e=>{if(void 0!=e.uuid&&void 0!=e.secret&&void 0!=e.remark){var o=t.find((t=>t.uuid==e.uuid));void 0==o?(t.push(e),s++):console.log("key already exists")}else t.push(e)})),localStorage.setItem("tokenData",JSON.stringify(t)),this.$message.success(`下载成功，去重后新增了${s}个到浏览器`),this.tokenData=JSON.parse(localStorage.getItem("tokenData")),this.tokenData.forEach((e=>{e.token=this.generateTOTP(e.secret)}))})).catch((e=>{console.error("Error:",e),this.$message.error("下载失败")})):this.$message.error(`请先在github上创建文件名为${this.remoteFileName}的gist，然后刷新本页面`):this.$message.error("请先登录Github")}},computed:{sortedTokenData(){return this.tokenData.slice().sort(((e,t)=>e.remark.localeCompare(t.remark)))}},created(){const e=localStorage.getItem("tokenData");e&&(this.tokenData=JSON.parse(e),this.tokenData.forEach((e=>{e.token=this.generateTOTP(e.secret)}))),setInterval(this.updateTokenIfNeeded,1e3),console.log(this.syncluodflag),this.syncluodflag&&this.checkGitHubAuthentication(),null!=localStorage.getItem("ghToken")&&(null!=localStorage.getItem("ghGistId")&&null!=localStorage.getItem("ghUsername")?(console.log(localStorage.getItem("ghGistId")),console.log(localStorage.getItem("ghUsername")),this.syncluodflag&&(this.showTag=!0,this.userName=localStorage.getItem("ghUsername"))):this.getUserUsername().then((()=>{this.userName=localStorage.getItem("ghUsername"),this.showTag=!0,this.findGistId()})))}},b=w,y=(0,f.Z)(b,r,n,!1,null,"356667ef",null),I=y.exports,S=o(8499),T=o.n(S);s["default"].use(T()),s["default"].config.productionTip=!1,new s["default"]({render:e=>e(I)}).$mount("#app")}},t={};function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(n.exports,n,n.exports,o),n.loaded=!0,n.exports}o.m=e,function(){o.amdO={}}(),function(){var e=[];o.O=function(t,s,r,n){if(!s){var a=1/0;for(h=0;h<e.length;h++){s=e[h][0],r=e[h][1],n=e[h][2];for(var i=!0,c=0;c<s.length;c++)(!1&n||a>=n)&&Object.keys(o.O).every((function(e){return o.O[e](s[c])}))?s.splice(c--,1):(i=!1,n<a&&(a=n));if(i){e.splice(h--,1);var l=r();void 0!==l&&(t=l)}}return t}n=n||0;for(var h=e.length;h>0&&e[h-1][2]>n;h--)e[h]=e[h-1];e[h]=[s,r,n]}}(),function(){o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,{a:t}),t}}(),function(){o.d=function(e,t){for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){o.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){o.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};o.O.j=function(t){return 0===e[t]};var t=function(t,s){var r,n,a=s[0],i=s[1],c=s[2],l=0;if(a.some((function(t){return 0!==e[t]}))){for(r in i)o.o(i,r)&&(o.m[r]=i[r]);if(c)var h=c(o)}for(t&&t(s);l<a.length;l++)n=a[l],o.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return o.O(h)},s=self["webpackChunkmy_vue_project"]=self["webpackChunkmy_vue_project"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=o.O(void 0,[998],(function(){return o(218)}));s=o.O(s)})();
//# sourceMappingURL=app.27032c6f.js.map